# Global options - MUST be first in the file
{
	# Use Let's Encrypt for automatic TLS certificates
	acme_ca https://acme-v02.api.letsencrypt.org/directory

	# Email for certificate notifications
	email admin@smigula.io

	log {
		level INFO
	}

	# Optional: Enable admin API
	admin localhost:2019
}

# Main domain - landing page
smigula.io {
	reverse_proxy landing:80

	# Optional: Redirect common paths
	redir /grafana https://grafana.smigula.io permanent
	redir /jaeger https://jaeger.smigula.io permanent
	redir /registry https://registry.smigula.io permanent

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	log {
		output file /data/logs/smigula.io.log
		format json
	}
}

grafana.smigula.io {
	reverse_proxy grafana:3000 {
		# Preserve original host header
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN" # Grafana needs iframe support
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	log {
		output file /data/logs/grafana.smigula.io.log
		format json
	}
}

jaeger.smigula.io {
	basic_auth {
		smigula $2a$14$oIo.CMitlcZBdt9/vFxPHuUT.Zvhnby7bohaTq53N8cX1sehsIldq
	}
	reverse_proxy jaeger:16686 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	log {
		output file /data/logs/jaeger.smigula.io.log
		format json
	}
}

registry.smigula.io {
	basic_auth {
		smigula $2a$14$oIo.CMitlcZBdt9/vFxPHuUT.Zvhnby7bohaTq53N8cX1sehsIldq
	}
	reverse_proxy registry:5000 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Docker registry specific headers
		header_up X-Forwarded-Port {server_port}
		header_up Docker-Distribution-Api-Version "registry/2.0"
	}

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "DENY"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	log {
		output file /data/logs/registry.smigula.io.log
		format json
	}
}

# Radarr
radarr.smigula.io {
	reverse_proxy radarr:7878 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /data/logs/radarr.smigula.io.log
		format json
	}
}

# Sonarr
sonarr.smigula.io {
	reverse_proxy sonarr:8989 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /data/logs/sonarr.smigula.io.log
		format json
	}
}

# Bazarr
bazarr.smigula.io {
	reverse_proxy bazarr:6767 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /data/logs/bazarr.smigula.io.log
		format json
	}
}

# Prowlarr
prowlarr.smigula.io {
	reverse_proxy prowlarr:9696 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /data/logs/prowlarr.smigula.io.log
		format json
	}
}

# Qbittorrent
bt.smigula.io {
	reverse_proxy qbittorrent:8080 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /data/logs/bt.smigula.io.log
		format json
	}
}

# Overseerr
request.smigula.io {
	reverse_proxy overseerr:5055 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /data/logs/request.smigula.io.log
		format json
	}
}

# Plex
plex.smigula.io {
	reverse_proxy plex:32400 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}

	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /var/log/caddy/plex.smigula.io.log
		format json
	}
}

# Dozzle
dozzle.smigula.io {
	reverse_proxy dozzle:8081 {
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		# Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
	}
	# Security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains"
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		Referrer-Policy "strict-origin-when-cross-origin"
	}

	# Logging
	log {
		output file /var/log/caddy/dozzle.smigula.io.log
		format json
	}
}