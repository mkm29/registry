# Global options - MUST be first in the file
{
        # Use Let's Encrypt for automatic TLS certificates
        acme_ca https://acme-v02.api.letsencrypt.org/directory

        # Alternative: Use ZeroSSL (uncomment to use instead of Let's Encrypt)
        # acme_ca https://acme.zerossl.com/v2/DV90

        # Email for certificate notifications
        email admin@smigula.io

        # Note: auto_https is enabled by default, no need to specify it

        # Log level (DEBUG, INFO, WARN, ERROR)
        log {
                level INFO
        }

        # Optional: Enable admin API
        admin localhost:2019
}

# Main domain - landing page
smigula.io {
        reverse_proxy landing:80

        basic_auth {
            smigula $2a$14$oIo.CMitlcZBdt9/vFxPHuUT.Zvhnby7bohaTq53N8cX1sehsIldq
        }

        # Optional: Redirect common paths
        redir /grafana https://grafana.smigula.io permanent
        redir /jaeger https://jaeger.smigula.io permanent
        redir /registry https://registry.smigula.io permanent

        # Security headers
        header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
                X-Content-Type-Options "nosniff"
                X-Frame-Options "DENY"
                X-XSS-Protection "1; mode=block"
                Referrer-Policy "strict-origin-when-cross-origin"
        }

        # Logging
        log {
                output file /data/logs/smigula.io.log
                format json
        }
}

# Grafana subdomain
grafana.smigula.io {
        basic_auth {
            smigula $2a$14$oIo.CMitlcZBdt9/vFxPHuUT.Zvhnby7bohaTq53N8cX1sehsIldq
        }
        reverse_proxy grafana:3000 {
                # Preserve original host header
                header_up Host {upstream_hostport}
                header_up X-Real-IP {remote_host}
                # Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
        }

        # Security headers
        header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains"
                X-Content-Type-Options "nosniff"
                X-Frame-Options "SAMEORIGIN" # Grafana needs iframe support
                Referrer-Policy "strict-origin-when-cross-origin"
        }

        # Logging
        log {
                output file /data/logs/grafana.smigula.io.log
                format json
        }
}

# Jaeger subdomain
jaeger.smigula.io {
        basic_auth {
            smigula $2a$14$oIo.CMitlcZBdt9/vFxPHuUT.Zvhnby7bohaTq53N8cX1sehsIldq
        }
        reverse_proxy jaeger:16686 {
                header_up Host {upstream_hostport}
                header_up X-Real-IP {remote_host}
                # Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic
        }

        # Security headers
        header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains"
                X-Content-Type-Options "nosniff"
                X-Frame-Options "SAMEORIGIN"
                Referrer-Policy "strict-origin-when-cross-origin"
        }

        # Logging
        log {
                output file /data/logs/jaeger.smigula.io.log
                format json
        }
}

# Docker Registry subdomain
registry.smigula.io {
        basic_auth {
            smigula $2a$14$oIo.CMitlcZBdt9/vFxPHuUT.Zvhnby7bohaTq53N8cX1sehsIldq
        }
        reverse_proxy registry:5000 {
                header_up Host {upstream_hostport}
                header_up X-Real-IP {remote_host}
                # Removed X-Forwarded-For and X-Forwarded-Proto as they're automatic

                # Docker registry specific headers
                header_up X-Forwarded-Port {server_port}
                header_up Docker-Distribution-Api-Version "registry/2.0"
        }

        # Security headers
        header {
                Strict-Transport-Security "max-age=31536000; includeSubDomains"
                X-Content-Type-Options "nosniff"
                X-Frame-Options "DENY"
                Referrer-Policy "strict-origin-when-cross-origin"
        }

        # Logging
        log {
                output file /data/logs/registry.smigula.io.log
                format json
        }
}